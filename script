local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local player = game.Players.LocalPlayer
local cam = workspace.CurrentCamera

local animationId = "rbxassetid://13294471966"
local debounce = false
local systemEnabled = false

-- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
local connections = {}
local animatorConnection = nil
local characterAddedConnection = nil

-- GUI Toggle
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.Name = "SwipeToggleGui"
screenGui.ResetOnSpawn = false  -- –í–∞–∂–Ω–æ! GUI –Ω–µ –±—É–¥–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–∏

local toggleButton = Instance.new("TextButton", screenGui)
toggleButton.Size = UDim2.new(0, 160, 0, 40)
toggleButton.Position = UDim2.new(0, 10, 0.85, 0)
toggleButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.GothamBold
toggleButton.Text = "Instant Twisted: OFF"
toggleButton.BorderSizePixel = 0
toggleButton.BackgroundTransparency = 0.1
toggleButton.AnchorPoint = Vector2.new(0, 0)
toggleButton.Active = true
toggleButton.Draggable = true

toggleButton.MouseButton1Click:Connect(function()
	systemEnabled = not systemEnabled
	if systemEnabled then
		toggleButton.Text = "Instant Twisted: ON"
		toggleButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
	else
		toggleButton.Text = "Instant Twisted: OFF"
		toggleButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
	end
end)

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
local function cleanupConnections()
	for _, connection in pairs(connections) do
		if connection then
			connection:Disconnect()
		end
	end
	connections = {}
	
	if animatorConnection then
		animatorConnection:Disconnect()
		animatorConnection = nil
	end
end

-- H√†m Swipe + Dash
local function swipeAndDash()
	if not player.Character then return end
	
	print("‚úÖ Swipe + Dash Triggered")

	-- G·ª≠i Remote Dash
	local args = {
		[1] = {
			["Dash"] = Enum.KeyCode.W,
			["Key"] = Enum.KeyCode.Q,
			["Goal"] = "KeyPress"
		}
	}
	local char = player.Character
	if char and char:FindFirstChild("Communicate") then
		char.Communicate:FireServer(unpack(args))
	end

	-- Swipe tr√°i
	local startCFrame = cam.CFrame
	local leftCFrame = startCFrame * CFrame.Angles(40, math.rad(-90), 180)

	cam.CameraType = Enum.CameraType.Scriptable
	local tween1 = TweenService:Create(cam, TweenInfo.new(0.1, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {CFrame = leftCFrame})
	tween1:Play()
	tween1.Completed:Wait()

	-- Quay l·∫°i
	task.wait(0.00001)
	local tween2 = TweenService:Create(cam, TweenInfo.new(0.001, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {CFrame = startCFrame})
	tween2:Play()
	tween2.Completed:Wait()

	-- Xoay ph·∫£i ch√©o
	task.wait(0.1)
	local angledCFrame = startCFrame * CFrame.Angles(math.rad(-6), math.rad(10), 0)
	local tween3 = TweenService:Create(cam, TweenInfo.new(0.0001, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {CFrame = angledCFrame})
	tween3:Play()
	tween3.Completed:Wait()

	cam.CameraType = Enum.CameraType.Custom
end

-- Theo d√µi animation
local function setupMonitor()
	-- –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
	cleanupConnections()
	
	-- –°–±—Ä–∞—Å—ã–≤–∞–µ–º debounce –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
	debounce = false
	
	local char = player.Character
	if not char then return end
	
	local function onAnimPlayed(track)
		if not systemEnabled then return end
		if not player.Character then return end
		
		if track.Animation and track.Animation.AnimationId == animationId then
			if debounce then return end
			debounce = true
			print("üé¨ Ph√°t hi·ªán animation:", animationId)

			-- üëâ L√πi l·∫°i 1 b∆∞·ªõc NGAY KHI animation ph√°t hi·ªán
			local char = player.Character
			local hrp = char and char:FindFirstChild("HumanoidRootPart")
			if hrp then
				local back = hrp.CFrame.LookVector * -1.5
				hrp.CFrame = hrp.CFrame + back
			end

			-- üëâ –ó–∞–¥–µ—Ä–∂–∫–∞ 0.35 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ swipe + dash
			task.delay(0.445, function()
				if player.Character then
					swipeAndDash()
				end
				task.wait(5) -- ‚è± Cooldown 5 gi√¢y
				debounce = false
			end)
		end
	end

	local function bindAnimator(animator)
		if animatorConnection then
			animatorConnection:Disconnect()
		end
		animatorConnection = animator.AnimationPlayed:Connect(onAnimPlayed)
	end

	local humanoid = char:WaitForChild("Humanoid")
	local animator = humanoid:FindFirstChildOfClass("Animator")

	if animator then
		bindAnimator(animator)
	else
		local connection = humanoid.ChildAdded:Connect(function(child)
			if child:IsA("Animator") then
				bindAnimator(child)
			end
		end)
		table.insert(connections, connection)
	end
	
	-- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–º–µ—Ä—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
	local humanoid = char:WaitForChild("Humanoid")
	local connection = humanoid.Died:Connect(function()
		-- –ü—Ä–∏ —Å–º–µ—Ä—Ç–∏ –æ—á–∏—â–∞–µ–º debounce
		debounce = false
		print("üíÄ –ü–µ—Ä—Å–æ–Ω–∞–∂ —É–º–µ—Ä, —Å–±—Ä–æ—Å debounce")
	end)
	table.insert(connections, connection)
end

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
local function initialize()
	-- –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
	if characterAddedConnection then
		characterAddedConnection:Disconnect()
	end
	
	-- –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
	characterAddedConnection = player.CharacterAdded:Connect(function(char)
		-- –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
		task.wait(0.5)
		setupMonitor()
	end)
	
	-- –ï—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂ —É–∂–µ –µ—Å—Ç—å
	if player.Character then
		task.wait(0.5)  -- –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
		setupMonitor()
	end
end

-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
initialize()

-- –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞
game:GetService("StarterGui"):SetCore("ResetButtonCallback", false)

local function onReset()
	-- –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É Reset
	debounce = false
	if player.Character then
		task.wait(1)  -- –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ
		setupMonitor()
	end
end

game:GetService("StarterGui"):SetCore("ResetButtonCallback", onReset)

-- –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ GUI
screenGui.Destroying:Connect(function()
	cleanupConnections()
	if characterAddedConnection then
		characterAddedConnection:Disconnect()
	end
end)
